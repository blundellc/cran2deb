#!/usr/bin/rc
umask 022
root=$1
shift
for (x in `{find $root/etc -type f -name '*.in'}) {
    y=`{echo $x | sed -e 's,.in$,,'}
    sed -e 's:@ROOT@:'^$root^':g' <$x >$y
}
mkdir -p /var/cache/cran2deb/results || exit 1
if ([ ! -e $root/var/archive ]) {
    # I symbolically link this into /var/www/
    mkdir $root/var/archive || exit 1
}
mini-dinstall --batch -c $root/etc/mini-dinstall.conf || exit 1
delta=`{hoc -e `{date +%s}^-^`{stat -c '%Y' /var/cache/cran2deb/cache.rda}}
update_period=10800
echo Cache is $delta seconds out of date.
if (~ $1 full) {
    delta=`{hoc -e $update_period^'+1'}
}
if (![ -e /var/cache/cran2deb/cache.rda ] || [ $delta -gt $update_period ]) {
    mode=create
    if ([ -e /var/cache/pbuilder/base-cran2deb.tgz ]) {
        mode=update
    }
    sudo pbuilder $mode --override-config --configfile $root/etc/pbuilderrc
    $root/exec/update_cache $root
}
if (![ -e /var/cache/cran2deb/cran2deb.db ] || [ $delta -gt $update_period ]) {
    cat $root/data/^(populate_licenses quit) | $root/exec/license $root
}
if (![ -e /var/cache/cran2deb/cran2deb.db ]) {
    cat $root/data/^(populate_depend_aliases populate_sysreq populate_forcedep quit) | $root/exec/depend $root
}

